---
layout: post
title: PHP实现执行定时任务的几种思路详解
date: 2017-05-11
categories: blog
tags: [php]
description: PHP实现执行定时任务的几种思路详解
---

## Linux服务器上使用CronTab定时执行php

我们先从相对比较复杂的服务器执行php谈起。

服务器上安装了php，就可以执行php文件，无论是否安装了nginx或Apache这样的服务器环境软件。而Linux中，使用命令行，用CronTab来定时任务，又是绝佳的选择，而且也是效率最高的选择。

### 首先，进入命令行模式。

作为服务器的linux一般都默认进入命令行模式的，当然，我们管理服务器也一般通过putty等工具远程连接到服务器，为了方便，我们用root用户登录。在命令行中键入：

	crontab -e

之后就会打开一个文件，并且是非编辑状态。

### 然后，开始编辑添加内容

因为这是vi的非编辑状态，通过敲键盘上的i，进入编辑模式，就可以编辑内容。

这个文件中的每一行就是一个定时任务，我们新建一行，就是新建一条定时任务。举个例子，增加一行，内容如下：

	00 * * * * lynx -dump https://www.yourdomain.com/script.php

这是什么意思呢？实际上上面这一行由两部分组成，前面一部分是时间，后面一部分是操作内容。例如上面这个，

	00 * * * *

就是指当当前时间的分钟数为00时，执行该定时任务。时间部分由5个时间参数组成，分别是：

	分　时　日　月　周

	第1列：表示分钟1～59 每分钟用或者 */1表示，/n表示每n分钟，例如*/8就是每8分钟的意思，下面也是类推
	第2列：表示小时1～23（0表示0点）
	第3列：表示日期1～31
	第4列：表示月份1～12
	第5列：标识号星期0～6（0表示星期天）

整个句子的后面部分就是操作的具体内容。

	lynx -dump https://www.yourdomain.com/script.php

意思就是说通过lynx访问这个url。我们在使用中主要用到lynx、curl、wget来实现对url的远程访问。

而如果要提高效率，**直接用php去执行本地php文件是最佳选择**，例如：

	00 */2 * * * /usr/local/bin/php /home/www/script.php

这条语句就可以在每2小时的0分钟，通过linux内部php环境执行script.php。

注意，这里可不是通过url访问，通过服务器环境来执行哦，而是直接执行，因为绕过了服务器环境，所以效率当然要高很多。

### 最后，退出编辑，保存文件

已经添加了几条需要的定时任务后，点击键盘上的Esc键，输入“ `:wq` ”回车，这样就保存了设置的定时任务，屏幕上也能看到提示创建了新的定时任务。

接下来就是好好写你的 `script.php` 了。

关于CronTab的更多用法这里就不介绍了，如果你想更灵活的使用这个定时任务功能，应该自己再去深入学习一下crontab。

## Windows服务器上使用bat定时执行php

windows上和linux上有一个类似的cmd和bat文件，bat文件类似于shell文件，执行这个bat文件，就相当于依次执行里面的命令。

所以，我们可以利用bat命令文件在windows服务器上面实现PHP定时任务。实际上在windows上定时任务，和linux上道理是一样的，只不过方法和途径不同。

### 首先，在一个你觉得比较适当的位置创建一个cron.bat文件

然后用文本编辑器打开它（记事本都可以），在里面写上这样的内容：

	D:\php\php.exe -q D:\website\test.php

这句话的意思就是，使用php.exe去执行test.php这个php文件，和上面的contab一样，绕过了服务器环境，执行效率也比较高。写好之后，点击保存，关闭编辑器。

### 接下来就是设置定时任务来运行cron.bat

依次打开：“开始–>控制面板–>任务计划–>添加任务计划”，在打开的界面中设置定时任务的时间、密码，通过选择，把 `cron.bat` 挂载进去。确定，这样一个定时任务就建立好了。

在这个定时任务上右键，运行，这个定时任务就开始执行了，到点时，就会运行 `cron.bat` 处理， `cron.bat` 再去执行php。